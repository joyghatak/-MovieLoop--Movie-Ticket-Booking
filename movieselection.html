<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Select Movie</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="centered">
  <div class="card">
    <h1>Choose Your Movie</h1>
    <div id="messageBox" class="message-box" style="display: none;"></div>

    <form onsubmit="saveMovie(event)">
      <label for="movie">Select a movie:</label>
      <select id="movie" name="movie" required>
        <option value="" disabled selected>Loading movies...</option>
      </select>

      <button type="submit" id="continueBtn" disabled>Continue</button>
    </form>
    <a href="index.html" style="font-size: small; color: #3498db; margin-top: 10px; display: block;" onclick="localStorage.clear()">Logout/Change User</a>
  </div>

  <script>
    // --- Configuration: Set explicit base URL for API calls ---
    const API_BASE_URL = 'http://localhost:5500/api';

    const movieSelect = document.getElementById("movie");
    const continueBtn = document.getElementById("continueBtn");
    const messageBox = document.getElementById("messageBox");
    let allMovies = []; 

    function displayMessage(message, type = 'success') {
      messageBox.textContent = message;
      messageBox.className = `message-box ${type}`;
      messageBox.style.display = 'block';
      setTimeout(() => {
        messageBox.style.display = 'none';
      }, 5000);
    }

    // 1. Check Auth and Fetch Movies
    window.onload = async function() {
      const username = localStorage.getItem("username");
      if (!username) {
        displayMessage("Please log in first.", 'error');
        setTimeout(() => { window.location.href = "index.html"; }, 1500);
        return;
      }

      try {
        // --- UPDATED API URL ---
        const response = await fetch(`${API_BASE_URL}/movies`);
        if (!response.ok) throw new Error('Failed to fetch movies');

        allMovies = await response.json();

        movieSelect.innerHTML = '<option value="" disabled selected>Select a showtime...</option>';

        if (allMovies.length === 0) {
          displayMessage("No movies available right now.", 'error');
          return;
        }

        // 2. Populate Select Options
        allMovies.forEach(movie => {
          const option = document.createElement('option');
          option.value = movie._id;
          option.textContent = `${movie.title} (${movie.showtime}) - â‚¹${movie.price} (${movie.availableSeats} seats left)`;
          option.setAttribute('data-price', movie.price);
          option.setAttribute('data-available-seats', movie.availableSeats);
          movieSelect.appendChild(option);
        });

        continueBtn.disabled = false;

      } catch (error) {
        console.error("Error fetching movies:", error);
        displayMessage('Network error. Could not connect to the server. Check your terminal.', 'error');
      }
    };

    // 3. Save Selected Movie Details and Redirect
    function saveMovie(e) {
      e.preventDefault();

      const selectedId = movieSelect.value;
      const selectedOption = movieSelect.options[movieSelect.selectedIndex];

      if (!selectedId) {
          displayMessage("Please select a movie.", 'error');
          return;
      }

      localStorage.setItem("selectedMovieId", selectedId);
      localStorage.setItem("selectedMoviePrice", selectedOption.getAttribute('data-price'));
      localStorage.setItem("selectedMovieName", selectedOption.textContent.split('(')[0].trim());
      localStorage.setItem("availableSeats", selectedOption.getAttribute('data-available-seats'));

      localStorage.removeItem("selectedSeats");

      window.location.href = "seats.html";
    }
  </script>
</body>
</html>
